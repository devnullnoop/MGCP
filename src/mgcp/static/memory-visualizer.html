<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Graph Visualizer - MGCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-cyan': '#4fc3f7',
                        'brand-dark': '#0a0a1a',
                        'brand-panel': '#1a1a2e',
                        'brand-surface': '#0f0f23',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes neuron-fire {
            0% { filter: brightness(1) drop-shadow(0 0 0 transparent); }
            20% { filter: brightness(2.5) drop-shadow(0 0 30px #4caf50); }
            60% { filter: brightness(2) drop-shadow(0 0 25px #4caf50); }
            100% { filter: brightness(1) drop-shadow(0 0 0 transparent); }
        }
        @keyframes traversal-pulse {
            0% { filter: brightness(1) drop-shadow(0 0 0 transparent); stroke: #fff; }
            30% { filter: brightness(1.8) drop-shadow(0 0 15px #f59e0b); stroke: #f59e0b; }
            100% { filter: brightness(1) drop-shadow(0 0 0 transparent); stroke: #fff; }
        }
        @keyframes link-fire {
            0% { stroke-opacity: 0.6; stroke-width: 2; }
            30% { stroke-opacity: 1; stroke-width: 4; stroke: #4caf50; }
            100% { stroke-opacity: 0.6; stroke-width: 2; }
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        .neuron-firing {
            animation: neuron-fire 2s ease-out;
        }
        .traversal-node {
            animation: traversal-pulse 1s ease-out;
        }
        .link-firing {
            animation: link-fire 1s ease-out;
        }
    </style>
</head>
<body class="bg-brand-dark text-gray-200 font-sans">
    <!-- Main Grid Container -->
    <div class="grid grid-cols-[1fr_350px] grid-rows-[auto_1fr_150px] min-h-screen h-screen gap-px bg-gray-700">

        <!-- Header -->
        <header class="col-span-2 bg-gradient-to-br from-brand-panel to-brand-surface px-6 py-4 flex justify-between items-center border-b border-brand-cyan">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-semibold text-white">Memory Graph Visualizer</h1>
                <a href="/" class="text-sm text-gray-400 hover:text-brand-cyan transition-colors">Dashboard</a>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex gap-2">
                    <button onclick="resetView()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200">
                        Reset View
                    </button>
                    <button onclick="toggleHeatmap()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200">
                        Toggle Heatmap
                    </button>
                    <button onclick="refreshGraph()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200">
                        Refresh
                    </button>
                </div>
                <div id="ws-status" class="w-3 h-3 rounded-full bg-gray-500"></div>
                <span id="ws-status-text" class="text-sm text-gray-300">Connecting...</span>
            </div>
        </header>

        <!-- Graph Container -->
        <div class="bg-brand-surface relative overflow-hidden">
            <svg id="graph" class="w-full h-full"></svg>

            <!-- Tooltip -->
            <div id="tooltip" class="absolute bg-brand-panel/95 border border-brand-cyan rounded-lg p-4 max-w-xs pointer-events-none opacity-0 transition-opacity duration-200 z-50 shadow-xl">
                <h4 id="tooltip-title" class="text-brand-cyan font-semibold mb-2">Lesson Title</h4>
                <p id="tooltip-action" class="text-sm text-gray-300 mb-2">Action text here</p>
                <div class="text-xs text-gray-400">
                    <span id="tooltip-meta">Version 1 - Used 5 times</span>
                </div>
            </div>

            <!-- Live Event Indicator -->
            <div id="live-event" class="absolute top-4 left-4 bg-green-500/20 border border-green-500 rounded-lg p-3 opacity-0 transition-all duration-300 max-w-md">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="live-event-text" class="text-sm text-green-400">Event received</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="bg-brand-panel flex flex-col overflow-hidden shadow-xl">

            <!-- Statistics Section -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Session Statistics</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-queries" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Queries</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-lessons" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Lessons Retrieved</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-unique" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Unique Lessons</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-events" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Events</div>
                    </div>
                </div>
            </div>

            <!-- Legend Section -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Node Legend</h3>
                <div class="flex flex-wrap gap-3 mb-3">
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-gray-300">Root</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-purple-600"></div>
                        <span class="text-gray-300">Category</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-brand-cyan"></div>
                        <span class="text-gray-300">Lesson</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-gray-300">Active</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                        <span class="text-gray-300">Workflow</span>
                    </div>
                </div>

                <!-- Heat Scale -->
                <div class="flex items-center gap-2 mt-3">
                    <span class="text-xs text-gray-400">Usage:</span>
                    <div class="flex-1 h-2 rounded-full bg-gradient-to-r from-brand-panel via-brand-cyan via-green-400 via-orange-400 to-red-500"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Cold</span>
                    <span>Hot</span>
                </div>
            </div>

            <!-- Live Events Section -->
            <div class="p-4 flex-1 flex flex-col overflow-hidden">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Live Events</h3>
                <div id="event-list" class="flex-1 overflow-y-auto space-y-2">
                    <div class="text-sm text-gray-500 italic">Waiting for events...</div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="col-span-2 bg-brand-panel p-4 border-t border-brand-cyan">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide">Event Timeline</h3>
                <span class="text-xs text-gray-400">Real-time</span>
            </div>
            <canvas id="timeline" class="h-24"></canvas>
        </div>
    </div>

    <script>
        // State
        let graphData = { nodes: [], links: [] };
        let simulation = null;
        let node = null;
        let link = null;
        let g = null;
        let activeNodes = new Set();
        let showHeatmap = true;
        let events = [];
        let totalQueries = 0;
        let totalLessonsRetrieved = 0;
        let uniqueLessons = new Set();
        let totalEvents = 0;
        let ws = null;

        // Set up SVG
        const svg = d3.select("#graph");
        const container = document.querySelector(".bg-brand-surface");
        let width = container.clientWidth;
        let height = container.clientHeight;

        svg.attr("width", width).attr("height", height);

        // Create arrow marker
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "-0 -5 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("orient", "auto")
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .append("path")
            .attr("d", "M 0,-5 L 10,0 L 0,5")
            .attr("fill", "#555");

        // Container for zoom
        g = svg.append("g");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.2, 4])
            .on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        // Timeline chart
        const timelineCtx = document.getElementById("timeline").getContext("2d");
        const timelineChart = new Chart(timelineCtx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    label: "Lessons",
                    data: [],
                    backgroundColor: "rgba(79, 195, 247, 0.6)",
                    borderColor: "#4fc3f7",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#9ca3af" }
                    },
                    x: {
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#9ca3af", maxRotation: 0 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        /**
         * Fetch graph data from API
         */
        async function fetchGraphData() {
            try {
                const response = await fetch('/api/graph');
                graphData = await response.json();
                renderGraph();
            } catch (error) {
                console.error('Failed to fetch graph data:', error);
            }
        }

        /**
         * Render the graph with D3
         */
        function renderGraph() {
            // Clear existing
            g.selectAll("*").remove();

            if (!graphData.nodes || graphData.nodes.length === 0) {
                g.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#666")
                    .text("No lessons yet. Query some lessons to see them here!");
                return;
            }

            // Create simulation
            simulation = d3.forceSimulation(graphData.nodes)
                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(d => {
                    if (d.relation === "parent") return 80;
                    if (d.relation === "workflow_step") return 60;
                    return 120;
                }))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(35));

            // Draw links
            link = g.append("g")
                .selectAll("line")
                .data(graphData.links)
                .join("line")
                .attr("stroke", d => {
                    if (d.relation === "related") return "#666";
                    if (d.relation === "workflow") return "#f59e0b";
                    if (d.relation === "step_lesson") return "#10b981";
                    return "#444";
                })
                .attr("stroke-width", d => d.relation === "parent" ? 2 : 1)
                .attr("stroke-dasharray", d => d.relation === "related" ? "5,5" : "none")
                .attr("stroke-opacity", 0.6);

            // Draw nodes
            node = g.append("g")
                .selectAll("g")
                .data(graphData.nodes)
                .join("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Node circles
            node.append("circle")
                .attr("r", d => {
                    if (d.type === "root") return 30;
                    if (d.type === "category") return 22;
                    if (d.type === "workflow") return 25;
                    if (d.type === "workflow_step") return 18;
                    return 16;
                })
                .attr("fill", d => getNodeColor(d))
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .style("cursor", "pointer");

            // Node labels
            node.append("text")
                .text(d => d.label.length > 20 ? d.label.substring(0, 18) + "..." : d.label)
                .attr("dy", d => {
                    if (d.type === "root") return 45;
                    if (d.type === "category" || d.type === "workflow") return 35;
                    return 28;
                })
                .attr("text-anchor", "middle")
                .attr("fill", "#9ca3af")
                .attr("font-size", "11px");

            // Tooltip
            const tooltip = document.getElementById("tooltip");
            node.on("mouseover", (event, d) => {
                document.getElementById("tooltip-title").textContent = d.label;
                document.getElementById("tooltip-action").textContent = d.action || "No description";
                document.getElementById("tooltip-meta").textContent = `Type: ${d.type} | Usage: ${d.usage || 0}%`;
                tooltip.style.left = (event.pageX + 15) + "px";
                tooltip.style.top = (event.pageY - 10) + "px";
                tooltip.classList.remove("opacity-0");
                tooltip.classList.add("opacity-100");
            }).on("mouseout", () => {
                tooltip.classList.remove("opacity-100");
                tooltip.classList.add("opacity-0");
            });

            // Update on tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        function getNodeColor(d) {
            if (activeNodes.has(d.id)) return "#4caf50";
            if (!showHeatmap) {
                if (d.type === "root") return "#f44336";
                if (d.type === "category") return "#9c27b0";
                if (d.type === "workflow") return "#f59e0b";
                if (d.type === "workflow_step") return "#fbbf24";
                return "#4fc3f7";
            }
            const usage = (d.usage || 0) / 100;
            if (usage > 0.8) return "#f44336";
            if (usage > 0.6) return "#ffb74d";
            if (usage > 0.4) return "#81c784";
            if (usage > 0.2) return "#4fc3f7";
            return "#1a1a3e";
        }

        function updateNodeColors() {
            if (node) {
                node.select("circle").attr("fill", d => getNodeColor(d));
            }
        }

        function dragstarted(event) {
            if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active && simulation) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        /**
         * Find path from root to a node
         */
        function findPathToNode(targetId) {
            const path = [];
            let current = graphData.nodes.find(n => n.id === targetId);
            while (current) {
                path.unshift(current.id);
                if (current.parent) {
                    current = graphData.nodes.find(n => n.id === current.parent);
                } else if (current.id !== "root") {
                    path.unshift("root");
                    break;
                } else {
                    break;
                }
            }
            return path;
        }

        /**
         * Fire neurons - animate specific lesson nodes with traversal effect
         */
        function fireNeurons(lessonIds) {
            if (!node || !link) return;

            // Build all paths to target lessons
            const allPaths = lessonIds.map(id => findPathToNode(id));
            const allNodesInPaths = new Set(allPaths.flat());

            // Step 1: Flash the root (query received)
            setTimeout(() => {
                node.filter(d => d.id === "root")
                    .select("circle")
                    .classed("traversal-node", true)
                    .transition()
                    .duration(400)
                    .attr("r", 42)
                    .transition()
                    .duration(400)
                    .attr("r", 30)
                    .on("end", function() {
                        d3.select(this).classed("traversal-node", false);
                    });
            }, 0);

            // Step 2: Animate through parent/category nodes (staggered)
            const parentNodes = [...allNodesInPaths].filter(id => {
                const n = graphData.nodes.find(x => x.id === id);
                return n && (n.type === "category" || n.type === "workflow") && id !== "root";
            });

            parentNodes.forEach((parentId, idx) => {
                setTimeout(() => {
                    // Flash parent node
                    node.filter(d => d.id === parentId)
                        .select("circle")
                        .classed("traversal-node", true)
                        .transition()
                        .duration(300)
                        .attr("r", 32)
                        .transition()
                        .duration(300)
                        .attr("r", 22)
                        .on("end", function() {
                            d3.select(this).classed("traversal-node", false);
                        });

                    // Flash links to this parent
                    link.filter(d => d.target.id === parentId || d.source.id === parentId)
                        .classed("link-firing", true)
                        .transition()
                        .duration(600)
                        .on("end", function() {
                            d3.select(this).classed("link-firing", false);
                        });
                }, 400 + (idx * 300));
            });

            // Step 3: Fire the target lessons (the big payoff)
            const targetDelay = 400 + (parentNodes.length * 300) + 200;

            setTimeout(() => {
                activeNodes = new Set(lessonIds);
                updateNodeColors();

                // Big pulse on target lessons
                node.filter(d => lessonIds.includes(d.id))
                    .select("circle")
                    .classed("neuron-firing", true)
                    .transition()
                    .duration(400)
                    .attr("r", d => {
                        const base = d.type === "root" ? 30 : d.type === "category" ? 22 : 16;
                        return base + 15;
                    })
                    .transition()
                    .duration(600)
                    .attr("r", d => {
                        const base = d.type === "root" ? 30 : d.type === "category" ? 22 : 16;
                        return base + 8;
                    })
                    .transition()
                    .duration(800)
                    .attr("r", d => d.type === "root" ? 30 : d.type === "category" ? 22 : 16)
                    .on("end", function() {
                        d3.select(this).classed("neuron-firing", false);
                    });

                // Flash links to target lessons
                link.filter(d => lessonIds.includes(d.target.id) || lessonIds.includes(d.source.id))
                    .classed("link-firing", true)
                    .transition()
                    .duration(1000)
                    .on("end", function() {
                        d3.select(this).classed("link-firing", false);
                    });
            }, targetDelay);

            // Clear active state after full animation
            setTimeout(() => {
                activeNodes.clear();
                updateNodeColors();
            }, targetDelay + 2500);
        }

        /**
         * Show live event indicator
         */
        function showLiveEvent(text) {
            const indicator = document.getElementById("live-event");
            document.getElementById("live-event-text").textContent = text;
            indicator.classList.remove("opacity-0");
            indicator.classList.add("opacity-100");
            setTimeout(() => {
                indicator.classList.remove("opacity-100");
                indicator.classList.add("opacity-0");
            }, 2000);
        }

        /**
         * Add event to the list
         */
        function addEventToList(event) {
            events.unshift(event);
            if (events.length > 20) events.pop();

            const list = document.getElementById("event-list");
            list.innerHTML = events.map((e, i) => {
                const time = new Date(e.timestamp).toLocaleTimeString();
                let icon = "?";
                let color = "gray";
                let desc = e.type;

                if (e.type === "query") {
                    icon = "Q";
                    color = "cyan";
                    desc = `Query: "${e.payload?.query_text?.substring(0, 30) || '...'}"`;
                } else if (e.type === "retrieve") {
                    icon = "R";
                    color = "green";
                    desc = `Retrieved ${e.payload?.lesson_ids?.length || 0} lessons`;
                } else if (e.type === "spider") {
                    icon = "S";
                    color = "purple";
                    desc = `Spidered from ${e.payload?.start_lesson_id}`;
                } else if (e.type === "add") {
                    icon = "+";
                    color = "amber";
                    desc = `Added: ${e.payload?.lesson_id}`;
                } else if (e.type === "refine") {
                    icon = "~";
                    color = "blue";
                    desc = `Refined: ${e.payload?.lesson_id}`;
                }

                return `
                    <div class="bg-white/5 rounded-lg p-2 border-l-4 border-${color}-500 ${i === 0 ? 'bg-' + color + '-500/10' : ''}" onclick="highlightEvent(${i})">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-${color}-500/20 text-${color}-400 flex items-center justify-center text-xs font-bold">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-gray-400">${time}</div>
                                <div class="text-sm text-gray-200 truncate">${desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join("") || '<div class="text-sm text-gray-500 italic">No events yet</div>';
        }

        /**
         * Highlight an event's lessons
         */
        function highlightEvent(index) {
            const event = events[index];
            if (event.payload?.lesson_ids) {
                fireNeurons(event.payload.lesson_ids);
            }
        }

        /**
         * Update statistics
         */
        function updateStats() {
            document.getElementById("stat-queries").textContent = totalQueries;
            document.getElementById("stat-lessons").textContent = totalLessonsRetrieved;
            document.getElementById("stat-unique").textContent = uniqueLessons.size;
            document.getElementById("stat-events").textContent = totalEvents;
        }

        /**
         * Connect to WebSocket
         */
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws/events`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById("ws-status").className = "w-3 h-3 rounded-full bg-green-500 animate-pulse-slow";
                document.getElementById("ws-status-text").textContent = "Connected";
                console.log("WebSocket connected");
            };

            ws.onclose = () => {
                document.getElementById("ws-status").className = "w-3 h-3 rounded-full bg-red-500";
                document.getElementById("ws-status-text").textContent = "Disconnected";
                console.log("WebSocket disconnected, reconnecting...");
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                // Ignore heartbeats
                if (data.type === "heartbeat") return;

                totalEvents++;
                addEventToList(data);

                // Handle different event types
                if (data.type === "query") {
                    totalQueries++;
                    showLiveEvent(`Query: "${data.payload?.query_text?.substring(0, 40) || '...'}"`);
                } else if (data.type === "retrieve") {
                    const lessonIds = data.payload?.lesson_ids || [];
                    totalLessonsRetrieved += lessonIds.length;
                    lessonIds.forEach(id => uniqueLessons.add(id));
                    showLiveEvent(`Retrieved ${lessonIds.length} lessons`);
                    fireNeurons(lessonIds);

                    // Update timeline
                    const time = new Date(data.timestamp).toLocaleTimeString();
                    timelineChart.data.labels.push(time);
                    timelineChart.data.datasets[0].data.push(lessonIds.length);
                    if (timelineChart.data.labels.length > 20) {
                        timelineChart.data.labels.shift();
                        timelineChart.data.datasets[0].data.shift();
                    }
                    timelineChart.update();
                } else if (data.type === "spider") {
                    const visitedIds = data.payload?.visited_ids || [];
                    showLiveEvent(`Spidered ${visitedIds.length} lessons`);
                    fireNeurons(visitedIds);
                } else if (data.type === "add") {
                    showLiveEvent(`New lesson: ${data.payload?.lesson_id}`);
                    // Refresh graph to show new lesson
                    setTimeout(fetchGraphData, 500);
                } else if (data.type === "refine") {
                    showLiveEvent(`Refined: ${data.payload?.lesson_id}`);
                    fireNeurons([data.payload?.lesson_id]);
                }

                updateStats();
            };
        }

        function resetView() {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            activeNodes.clear();
            updateNodeColors();
        }

        function toggleHeatmap() {
            showHeatmap = !showHeatmap;
            updateNodeColors();
        }

        function refreshGraph() {
            fetchGraphData();
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            width = container.clientWidth;
            height = container.clientHeight;
            svg.attr("width", width).attr("height", height);
            if (simulation) {
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        });

        // Initialize
        fetchGraphData();
        connectWebSocket();
    </script>
</body>
</html>
