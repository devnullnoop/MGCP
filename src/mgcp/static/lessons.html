<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lessons - Lesson Memory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-cyan': '#4fc3f7',
                        'brand-dark': '#0a0a1a',
                        'brand-panel': '#1a1a2e',
                        'brand-surface': '#0f0f23',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-dark text-gray-200 font-sans min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-br from-brand-panel to-brand-surface px-6 py-4 flex justify-between items-center border-b border-brand-cyan">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-semibold text-white">Lesson Management</h1>
            <nav class="flex gap-4 text-sm">
                <a href="/" class="text-gray-400 hover:text-brand-cyan transition-colors">Dashboard</a>
                <a href="/session" class="text-gray-400 hover:text-brand-cyan transition-colors">Sessions</a>
                <a href="/lessons" class="text-brand-cyan">Lessons</a>
                <a href="/projects" class="text-gray-400 hover:text-brand-cyan transition-colors">Projects</a>
            </nav>
        </div>
        <div class="flex items-center gap-4">
            <input type="text" id="search-input" placeholder="Search lessons..."
                   class="bg-brand-dark border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-brand-cyan focus:outline-none w-64"
                   oninput="filterLessons()">
            <select id="filter-category" class="bg-brand-dark border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-brand-cyan focus:outline-none" onchange="filterLessons()">
                <option value="">All Categories</option>
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 max-w-6xl">
        <!-- Stats Bar -->
        <div class="flex gap-6 mb-6 text-sm">
            <div class="text-gray-400">
                Total: <span id="total-count" class="text-white font-medium">0</span> lessons
            </div>
            <div class="text-gray-400">
                Categories: <span id="category-count" class="text-white font-medium">0</span>
            </div>
            <div class="text-gray-400">
                Showing: <span id="showing-count" class="text-white font-medium">0</span>
            </div>
        </div>

        <!-- Lesson List -->
        <div id="lesson-list" class="space-y-3">
            <div class="text-gray-500 text-center py-12">Loading lessons...</div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
        <div class="bg-brand-panel rounded-lg border border-gray-700 w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                <h2 id="modal-title" class="text-lg font-semibold text-white">Edit Lesson</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <form id="lesson-form" class="space-y-5">
                    <input type="hidden" id="form-id">

                    <!-- ID (readonly) -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Lesson ID</label>
                        <input type="text" id="form-lesson-id" readonly
                               class="w-full bg-brand-dark/50 border border-gray-700 rounded px-3 py-2 text-gray-400 font-mono text-sm">
                    </div>

                    <!-- Trigger -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Trigger <span class="text-gray-500">(keywords that activate this lesson)</span></label>
                        <input type="text" id="form-trigger"
                               class="w-full bg-brand-dark border border-gray-600 rounded px-3 py-2 text-white focus:border-brand-cyan focus:outline-none"
                               placeholder="authentication, login, security">
                    </div>

                    <!-- Action -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Action <span class="text-gray-500">(what to do - imperative)</span></label>
                        <textarea id="form-action" rows="3"
                                  class="w-full bg-brand-dark border border-gray-600 rounded px-3 py-2 text-white focus:border-brand-cyan focus:outline-none"
                                  placeholder="Always validate user input before processing..."></textarea>
                    </div>

                    <!-- Rationale -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Rationale <span class="text-gray-500">(why this matters)</span></label>
                        <textarea id="form-rationale" rows="2"
                                  class="w-full bg-brand-dark border border-gray-600 rounded px-3 py-2 text-white focus:border-brand-cyan focus:outline-none"
                                  placeholder="Prevents security vulnerabilities and unexpected behavior..."></textarea>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Tags <span class="text-gray-500">(comma-separated)</span></label>
                        <input type="text" id="form-tags"
                               class="w-full bg-brand-dark border border-gray-600 rounded px-3 py-2 text-white focus:border-brand-cyan focus:outline-none"
                               placeholder="security, validation, best-practice">
                    </div>

                    <!-- Metadata (readonly) -->
                    <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-700">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Version</label>
                            <div id="form-version" class="text-sm text-gray-300">1</div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Usage Count</label>
                            <div id="form-usage" class="text-sm text-gray-300">0</div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Last Refined</label>
                            <div id="form-refined" class="text-sm text-gray-300">-</div>
                        </div>
                    </div>

                    <!-- Relationships -->
                    <div class="pt-4 border-t border-gray-700">
                        <label class="block text-sm text-gray-400 mb-2">Relationships</label>
                        <div id="form-relationships" class="space-y-2 text-sm">
                            <div class="text-gray-500">No relationships</div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-gray-700 flex justify-between">
                <button onclick="deleteLesson()" class="bg-red-500/20 border border-red-500 text-red-400 px-4 py-2 rounded text-sm hover:bg-red-500/40 transition-all">
                    Delete Lesson
                </button>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="bg-gray-700 text-gray-300 px-4 py-2 rounded text-sm hover:bg-gray-600 transition-all">
                        Cancel
                    </button>
                    <button onclick="saveLesson()" class="bg-brand-cyan text-brand-dark px-6 py-2 rounded text-sm font-medium hover:bg-brand-cyan/80 transition-all">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let lessons = [];
        let currentLesson = null;

        // ================================================================
        // API Functions
        // ================================================================

        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                console.error(`API error (${endpoint}):`, err);
                return null;
            }
        }

        async function loadLessons() {
            const data = await fetchAPI('/api/lessons');
            if (data) {
                lessons = data;
                populateCategories();
                renderLessons();
            }
        }

        // ================================================================
        // Render Functions
        // ================================================================

        function populateCategories() {
            const categories = new Set();
            lessons.forEach(lesson => {
                if (!lesson.parent_id) {
                    categories.add(lesson.id);
                }
            });

            const select = document.getElementById('filter-category');
            select.innerHTML = '<option value="">All Categories</option>' +
                Array.from(categories).sort().map(cat =>
                    `<option value="${cat}">${cat.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</option>`
                ).join('');

            document.getElementById('category-count').textContent = categories.size;
        }

        function filterLessons() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('filter-category').value;

            const filtered = lessons.filter(lesson => {
                const matchesSearch = !search ||
                    lesson.id.toLowerCase().includes(search) ||
                    lesson.action.toLowerCase().includes(search) ||
                    lesson.trigger.toLowerCase().includes(search) ||
                    (lesson.tags || []).some(t => t.toLowerCase().includes(search));

                const matchesCategory = !category ||
                    lesson.id === category ||
                    lesson.parent_id === category;

                return matchesSearch && matchesCategory;
            });

            renderLessons(filtered);
        }

        function renderLessons(filteredLessons = lessons) {
            const container = document.getElementById('lesson-list');

            document.getElementById('total-count').textContent = lessons.length;
            document.getElementById('showing-count').textContent = filteredLessons.length;

            if (!filteredLessons || filteredLessons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        No lessons found
                    </div>
                `;
                return;
            }

            // Group by parent
            const grouped = {};
            const roots = [];

            filteredLessons.forEach(lesson => {
                if (!lesson.parent_id) {
                    roots.push(lesson);
                    grouped[lesson.id] = [];
                } else {
                    if (!grouped[lesson.parent_id]) {
                        grouped[lesson.parent_id] = [];
                    }
                    grouped[lesson.parent_id].push(lesson);
                }
            });

            container.innerHTML = roots.map(root => {
                const children = grouped[root.id] || [];
                const isCategory = children.length > 0;

                return `
                    <div class="bg-brand-panel rounded-lg border border-gray-700">
                        <!-- Root/Category Lesson -->
                        <div class="p-4 ${isCategory ? 'border-b border-gray-700' : ''} hover:bg-white/5 cursor-pointer transition-all" onclick="openLesson('${root.id}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-brand-cyan font-medium">${escapeHtml(root.id)}</span>
                                        ${isCategory ? '<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Category</span>' : ''}
                                        <span class="text-xs text-gray-500">v${root.version}</span>
                                    </div>
                                    <p class="text-sm text-gray-300">${escapeHtml(root.action)}</p>
                                    ${root.tags && root.tags.length ? `
                                        <div class="flex gap-1 mt-2">
                                            ${root.tags.map(tag => `<span class="text-xs bg-gray-700 text-gray-400 px-2 py-0.5 rounded">${escapeHtml(tag)}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-right text-xs text-gray-500">
                                    <div>Used ${root.usage_count}x</div>
                                    ${root.relationships && root.relationships.length ? `<div>${root.relationships.length} relationships</div>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Child Lessons -->
                        ${children.length > 0 ? `
                            <div class="divide-y divide-gray-700/50">
                                ${children.map(child => `
                                    <div class="p-4 pl-8 hover:bg-white/5 cursor-pointer transition-all" onclick="openLesson('${child.id}')">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-gray-400 text-sm">â””</span>
                                                    <span class="text-brand-cyan/80 font-medium text-sm">${escapeHtml(child.id)}</span>
                                                    <span class="text-xs text-gray-500">v${child.version}</span>
                                                </div>
                                                <p class="text-sm text-gray-400 ml-5">${escapeHtml(child.action)}</p>
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                Used ${child.usage_count}x
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ================================================================
        // Modal Functions
        // ================================================================

        async function openLesson(lessonId) {
            const lesson = await fetchAPI(`/api/lessons/${lessonId}`);
            if (!lesson) return;

            currentLesson = lesson;

            document.getElementById('modal-title').textContent = 'Edit Lesson';
            document.getElementById('form-id').value = lesson.id;
            document.getElementById('form-lesson-id').value = lesson.id;
            document.getElementById('form-trigger').value = lesson.trigger;
            document.getElementById('form-action').value = lesson.action;
            document.getElementById('form-rationale').value = lesson.rationale || '';
            document.getElementById('form-tags').value = (lesson.tags || []).join(', ');
            document.getElementById('form-version').textContent = lesson.version;
            document.getElementById('form-usage').textContent = lesson.usage_count;
            document.getElementById('form-refined').textContent = lesson.last_refined ?
                new Date(lesson.last_refined).toLocaleString() : '-';

            // Render relationships
            const relContainer = document.getElementById('form-relationships');
            if (lesson.relationships && lesson.relationships.length > 0) {
                relContainer.innerHTML = lesson.relationships.map(rel => `
                    <div class="flex items-center gap-2 bg-brand-dark/50 rounded px-3 py-2">
                        <span class="text-xs px-2 py-0.5 rounded ${getRelTypeClass(rel.type)}">${rel.type}</span>
                        <span class="text-gray-300">${rel.target}</span>
                        <span class="text-gray-500 text-xs">(weight: ${(rel.weight * 100).toFixed(0)}%)</span>
                    </div>
                `).join('');
            } else {
                relContainer.innerHTML = '<div class="text-gray-500">No relationships</div>';
            }

            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
            currentLesson = null;
        }

        function getRelTypeClass(type) {
            const classes = {
                'prerequisite': 'bg-orange-500/20 text-orange-400',
                'sequence_next': 'bg-blue-500/20 text-blue-400',
                'alternative': 'bg-pink-500/20 text-pink-400',
                'complements': 'bg-purple-500/20 text-purple-400',
                'related': 'bg-green-500/20 text-green-400',
            };
            return classes[type] || 'bg-gray-500/20 text-gray-400';
        }

        // ================================================================
        // CRUD Functions
        // ================================================================

        async function saveLesson() {
            if (!currentLesson) return;

            const data = {
                trigger: document.getElementById('form-trigger').value,
                action: document.getElementById('form-action').value,
                rationale: document.getElementById('form-rationale').value,
                tags: document.getElementById('form-tags').value
                    .split(',').map(t => t.trim()).filter(t => t)
            };

            const result = await fetchAPI(`/api/lessons/${currentLesson.id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (result && !result.error) {
                closeModal();
                await loadLessons();
            } else {
                alert('Error saving lesson: ' + (result?.error || 'Unknown error'));
            }
        }

        async function deleteLesson() {
            if (!currentLesson) return;

            if (!confirm(`Delete lesson "${currentLesson.id}"? This cannot be undone.`)) {
                return;
            }

            const result = await fetchAPI(`/api/lessons/${currentLesson.id}`, {
                method: 'DELETE'
            });

            if (result && !result.error) {
                closeModal();
                await loadLessons();
            } else {
                alert('Error deleting lesson: ' + (result?.error || 'Unknown error'));
            }
        }

        // ================================================================
        // Utilities
        // ================================================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadLessons();
    </script>
</body>
</html>
