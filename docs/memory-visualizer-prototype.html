<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Graph Visualizer - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-cyan': '#4fc3f7',
                        'brand-dark': '#0a0a1a',
                        'brand-panel': '#1a1a2e',
                        'brand-surface': '#0f0f23',
                    }
                }
            }
        }
    </script>
    <style>
        /* Minimal CSS for D3/animations that can't be done in Tailwind */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-brand-dark text-gray-200 font-sans">
    <!-- Main Grid Container -->
    <div class="grid grid-cols-[1fr_350px] grid-rows-[auto_1fr_150px] min-h-screen h-screen gap-px bg-gray-700">

        <!-- Header -->
        <header class="col-span-2 bg-gradient-to-br from-brand-panel to-brand-surface px-6 py-4 flex justify-between items-center border-b border-brand-cyan">
            <h1 class="text-xl font-semibold text-white">Memory Graph Visualizer</h1>
            <div class="flex items-center gap-4">
                <div class="flex gap-2">
                    <button onclick="simulateQuery()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan focus:ring-offset-2 focus:ring-offset-brand-dark">
                        Simulate Query
                    </button>
                    <button onclick="resetView()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan focus:ring-offset-2 focus:ring-offset-brand-dark">
                        Reset View
                    </button>
                    <button onclick="toggleHeatmap()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan focus:ring-offset-2 focus:ring-offset-brand-dark">
                        Toggle Heatmap
                    </button>
                </div>
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse-slow"></div>
                <span class="text-sm text-gray-300">Session Active</span>
            </div>
        </header>

        <!-- Graph Container -->
        <div class="bg-brand-surface relative overflow-hidden">
            <svg id="graph" class="w-full h-full"></svg>

            <!-- Tooltip -->
            <div id="tooltip" class="absolute bg-brand-panel/95 border border-brand-cyan rounded-lg p-4 max-w-xs pointer-events-none opacity-0 transition-opacity duration-200 z-50 shadow-xl">
                <h4 id="tooltip-title" class="text-brand-cyan font-semibold mb-2">Lesson Title</h4>
                <p id="tooltip-action" class="text-sm text-gray-300 mb-2">Action text here</p>
                <div class="text-xs text-gray-400">
                    <span id="tooltip-meta">Version 1 • Used 5 times</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="bg-brand-panel flex flex-col overflow-hidden shadow-xl">

            <!-- Statistics Section -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Session Statistics</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-queries" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Queries</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-lessons" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Lessons Retrieved</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-unique" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Unique Lessons</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center">
                        <div id="stat-depth" class="text-2xl font-bold text-brand-cyan">0</div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Max Depth</div>
                    </div>
                </div>
            </div>

            <!-- Legend Section -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Node Legend</h3>
                <div class="flex flex-wrap gap-3 mb-3">
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-gray-300">Root</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-purple-600"></div>
                        <span class="text-gray-300">Category</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-brand-cyan"></div>
                        <span class="text-gray-300">Lesson</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-gray-300">Active</span>
                    </div>
                </div>

                <!-- Heat Scale -->
                <div class="flex items-center gap-2 mt-3">
                    <span class="text-xs text-gray-400">Usage:</span>
                    <div class="flex-1 h-2 rounded-full bg-gradient-to-r from-brand-panel via-brand-cyan via-green-400 via-orange-400 to-red-500"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Cold</span>
                    <span>Hot</span>
                </div>
            </div>

            <!-- Recent Queries Section -->
            <div class="p-4 flex-1 flex flex-col overflow-hidden">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-3">Recent Queries</h3>
                <div id="query-list" class="flex-1 overflow-y-auto space-y-2">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="col-span-2 bg-brand-panel p-4 border-t border-brand-cyan">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide">Query Timeline</h3>
                <span class="text-xs text-gray-400">Last 30 minutes</span>
            </div>
            <canvas id="timeline" class="h-24"></canvas>
        </div>
    </div>

    <script>
        /**
         * Memory Graph Visualizer - D3.js Force Graph
         *
         * This script creates an interactive force-directed graph visualization
         * of the lesson memory hierarchy. Nodes represent lessons and categories,
         * while links show parent-child and cross-reference relationships.
         */

        // Sample lesson graph data for prototype demonstration
        const graphData = {
            nodes: [
                { id: "root", label: "Global Lessons", type: "root", usage: 100 },
                { id: "verification", label: "Verification", type: "category", parent: "root", usage: 80 },
                { id: "apis", label: "API Research", type: "category", parent: "root", usage: 60 },
                { id: "testing", label: "Testing", type: "category", parent: "root", usage: 70 },
                { id: "verify-before-assert", label: "Verify Before Assert", type: "lesson", parent: "verification", usage: 90, action: "Always verify assumptions with actual data before making assertions in code." },
                { id: "check-api-versions", label: "Check API Versions", type: "lesson", parent: "apis", usage: 45, action: "Before using any API, verify the version and check for breaking changes." },
                { id: "memory-estimation", label: "Memory Estimation", type: "lesson", parent: "verification", usage: 30, action: "Test memory calculations with known inputs before integrating into production." },
                { id: "test-known-inputs", label: "Test Known Inputs", type: "lesson", parent: "testing", usage: 55, action: "Always test with known input/output pairs first." },
                { id: "sanity-check", label: "Sanity Check Magnitude", type: "lesson", parent: "verification", usage: 40, action: "Verify output magnitudes are reasonable before proceeding." },
                { id: "rust-crates", label: "Rust Crate Versions", type: "lesson", parent: "apis", usage: 25, action: "Check crates.io for latest versions and compatibility." },
                { id: "python-pypi", label: "Python PyPI Versions", type: "lesson", parent: "apis", usage: 35, action: "Verify PyPI package versions before adding to requirements." },
            ],
            links: [
                { source: "root", target: "verification" },
                { source: "root", target: "apis" },
                { source: "root", target: "testing" },
                { source: "verification", target: "verify-before-assert" },
                { source: "verification", target: "memory-estimation" },
                { source: "verification", target: "sanity-check" },
                { source: "apis", target: "check-api-versions" },
                { source: "apis", target: "rust-crates" },
                { source: "apis", target: "python-pypi" },
                { source: "testing", target: "test-known-inputs" },
                // Cross-links (related lessons)
                { source: "memory-estimation", target: "sanity-check", type: "related" },
                { source: "memory-estimation", target: "test-known-inputs", type: "related" },
            ]
        };

        // Query history and state
        const queries = [];
        let activeNodes = new Set();
        let showHeatmap = true;

        // Set up SVG dimensions
        const svg = d3.select("#graph");
        const container = document.querySelector(".bg-brand-surface");
        const width = container.clientWidth;
        const height = container.clientHeight;

        svg.attr("width", width).attr("height", height);

        // Create arrow marker for directed links
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "-0 -5 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("orient", "auto")
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .append("path")
            .attr("d", "M 0,-5 L 10,0 L 0,5")
            .attr("fill", "#555");

        // Create container group for zoom/pan transformations
        const g = svg.append("g");

        // Enable zoom and pan behavior
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        // Initialize force simulation
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(40));

        // Draw links between nodes
        const link = g.append("g")
            .selectAll("line")
            .data(graphData.links)
            .join("line")
            .attr("stroke", d => d.type === "related" ? "#666" : "#444")
            .attr("stroke-width", d => d.type === "related" ? 1 : 2)
            .attr("stroke-dasharray", d => d.type === "related" ? "5,5" : "none")
            .attr("marker-end", "url(#arrowhead)");

        // Draw nodes with drag behavior
        const node = g.append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .join("g")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // Node circles with size based on type
        node.append("circle")
            .attr("r", d => d.type === "root" ? 25 : d.type === "category" ? 20 : 15)
            .attr("fill", d => getNodeColor(d))
            .attr("stroke", "#fff")
            .attr("stroke-width", 2)
            .style("cursor", "pointer");

        // Node labels positioned below circles
        node.append("text")
            .text(d => d.label)
            .attr("dy", d => d.type === "root" ? 40 : 30)
            .attr("text-anchor", "middle")
            .attr("fill", "#9ca3af")
            .attr("font-size", "12px");

        // Tooltip event handlers
        const tooltip = document.getElementById("tooltip");
        node.on("mouseover", (event, d) => {
            if (d.type === "lesson") {
                document.getElementById("tooltip-title").textContent = d.label;
                document.getElementById("tooltip-action").textContent = d.action || "No action defined";
                document.getElementById("tooltip-meta").textContent = `Usage: ${d.usage}% • Type: ${d.type}`;
                tooltip.style.left = (event.pageX + 15) + "px";
                tooltip.style.top = (event.pageY - 10) + "px";
                tooltip.classList.remove("opacity-0");
                tooltip.classList.add("opacity-100");
            }
        }).on("mouseout", () => {
            tooltip.classList.remove("opacity-100");
            tooltip.classList.add("opacity-0");
        });

        // Update positions on each simulation tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        /**
         * Determines node color based on type, active state, and heatmap mode
         */
        function getNodeColor(d) {
            if (activeNodes.has(d.id)) return "#4caf50";
            if (!showHeatmap) {
                if (d.type === "root") return "#f44336";
                if (d.type === "category") return "#9c27b0";
                return "#4fc3f7";
            }
            // Heatmap coloring based on usage percentage
            const usage = d.usage / 100;
            if (usage > 0.8) return "#f44336";
            if (usage > 0.6) return "#ffb74d";
            if (usage > 0.4) return "#81c784";
            if (usage > 0.2) return "#4fc3f7";
            return "#1a1a3e";
        }

        /**
         * Updates all node colors based on current state
         */
        function updateNodeColors() {
            node.select("circle").attr("fill", d => getNodeColor(d));
        }

        // Drag event handlers for node manipulation
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        // Initialize Chart.js timeline visualization
        const timelineCtx = document.getElementById("timeline").getContext("2d");
        const timelineChart = new Chart(timelineCtx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    label: "Lessons Retrieved",
                    data: [],
                    backgroundColor: "rgba(79, 195, 247, 0.6)",
                    borderColor: "#4fc3f7",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#9ca3af" }
                    },
                    x: {
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#9ca3af", maxRotation: 0 }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Sample queries for demonstration
        const sampleQueries = [
            { text: "implementing authentication", lessons: ["verify-before-assert", "check-api-versions", "test-known-inputs"] },
            { text: "memory optimization", lessons: ["memory-estimation", "sanity-check", "verify-before-assert"] },
            { text: "adding rust dependency", lessons: ["rust-crates", "check-api-versions"] },
            { text: "writing unit tests", lessons: ["test-known-inputs", "verify-before-assert"] },
            { text: "python package update", lessons: ["python-pypi", "check-api-versions"] },
        ];

        /**
         * Simulates a query event for demonstration purposes
         */
        function simulateQuery() {
            const query = sampleQueries[Math.floor(Math.random() * sampleQueries.length)];
            const time = new Date().toLocaleTimeString();

            // Add to query history
            queries.unshift({ ...query, time });
            updateQueryList();

            // Highlight retrieved lessons
            activeNodes = new Set(query.lessons);
            updateNodeColors();

            // Animate pulse effect on active nodes
            node.filter(d => activeNodes.has(d.id))
                .select("circle")
                .transition()
                .duration(200)
                .attr("r", d => (d.type === "root" ? 25 : d.type === "category" ? 20 : 15) + 10)
                .transition()
                .duration(200)
                .attr("r", d => d.type === "root" ? 25 : d.type === "category" ? 20 : 15);

            // Update statistics
            updateStats();

            // Update timeline chart
            timelineChart.data.labels.push(time);
            timelineChart.data.datasets[0].data.push(query.lessons.length);
            if (timelineChart.data.labels.length > 15) {
                timelineChart.data.labels.shift();
                timelineChart.data.datasets[0].data.shift();
            }
            timelineChart.update();

            // Clear highlights after delay
            setTimeout(() => {
                activeNodes.clear();
                updateNodeColors();
            }, 3000);
        }

        /**
         * Updates the query list in the sidebar
         */
        function updateQueryList() {
            const list = document.getElementById("query-list");
            list.innerHTML = queries.slice(0, 10).map((q, i) => `
                <div class="bg-white/5 rounded-lg p-3 border-l-4 ${i === 0 ? 'border-green-500 bg-green-500/10' : 'border-brand-cyan'} cursor-pointer hover:bg-white/10 transition-all duration-200" onclick="highlightQuery(${i})">
                    <div class="text-xs text-gray-400">${q.time}</div>
                    <div class="text-sm text-gray-200 my-1">"${q.text}"</div>
                    <div class="text-xs text-green-400">${q.lessons.length} lessons retrieved</div>
                </div>
            `).join("");
        }

        /**
         * Highlights lessons from a specific query
         */
        function highlightQuery(index) {
            const query = queries[index];
            activeNodes = new Set(query.lessons);
            updateNodeColors();
            setTimeout(() => {
                activeNodes.clear();
                updateNodeColors();
            }, 3000);
        }

        /**
         * Updates session statistics display
         */
        function updateStats() {
            document.getElementById("stat-queries").textContent = queries.length;
            document.getElementById("stat-lessons").textContent = queries.reduce((sum, q) => sum + q.lessons.length, 0);
            const uniqueLessons = new Set(queries.flatMap(q => q.lessons));
            document.getElementById("stat-unique").textContent = uniqueLessons.size;
            document.getElementById("stat-depth").textContent = Math.max(...queries.map(q => q.lessons.length), 0);
        }

        /**
         * Resets the graph view to initial zoom/pan state
         */
        function resetView() {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            activeNodes.clear();
            updateNodeColors();
        }

        /**
         * Toggles between heatmap and type-based coloring
         */
        function toggleHeatmap() {
            showHeatmap = !showHeatmap;
            updateNodeColors();
        }

        // Run initial demo queries
        setTimeout(() => simulateQuery(), 500);
        setTimeout(() => simulateQuery(), 1500);
        setTimeout(() => simulateQuery(), 2500);
    </script>
</body>
</html>
