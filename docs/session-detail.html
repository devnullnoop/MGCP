<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail - Lesson Memory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        /**
         * Tailwind CSS Configuration
         */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-cyan': '#4fc3f7',
                        'brand-dark': '#0a0a1a',
                        'brand-panel': '#1a1a2e',
                        'brand-surface': '#0f0f23',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-dark text-gray-200 font-sans min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-br from-brand-panel to-brand-surface px-6 py-4 flex justify-between items-center border-b border-brand-cyan">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-semibold text-white">Session Detail</h1>
            <nav class="flex gap-4 text-sm">
                <a href="/" class="text-gray-400 hover:text-brand-cyan transition-colors">Dashboard</a>
                <a href="/session" class="text-brand-cyan">Sessions</a>
                <a href="/lessons" class="text-gray-400 hover:text-brand-cyan transition-colors">Lessons</a>
                <a href="/projects" class="text-gray-400 hover:text-brand-cyan transition-colors">Projects</a>
            </nav>
        </div>
        <div class="flex items-center gap-4">
            <span id="session-id" class="text-sm text-gray-400 font-mono"></span>
            <button onclick="loadSessionData()" class="bg-brand-cyan/20 border border-brand-cyan text-brand-cyan px-4 py-2 rounded text-sm font-medium hover:bg-brand-cyan/40 transition-all duration-200">
                Refresh
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 max-w-6xl">
        <!-- Session Summary -->
        <div class="bg-brand-panel rounded-lg p-6 mb-8 border border-gray-700">
            <h2 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-4">Session Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white/5 p-4 rounded-lg text-center">
                    <div id="stat-queries" class="text-3xl font-bold text-brand-cyan">0</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide mt-1">Queries</div>
                </div>
                <div class="bg-white/5 p-4 rounded-lg text-center">
                    <div id="stat-retrievals" class="text-3xl font-bold text-green-400">0</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide mt-1">Retrievals</div>
                </div>
                <div class="bg-white/5 p-4 rounded-lg text-center">
                    <div id="stat-lessons-added" class="text-3xl font-bold text-purple-400">0</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide mt-1">Lessons Added</div>
                </div>
                <div class="bg-white/5 p-4 rounded-lg text-center">
                    <div id="stat-duration" class="text-3xl font-bold text-orange-400">0m</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide mt-1">Duration</div>
                </div>
            </div>
        </div>

        <!-- Interaction Timeline -->
        <div class="bg-brand-panel rounded-lg p-6 border border-gray-700">
            <h2 class="text-brand-cyan text-sm font-semibold uppercase tracking-wide mb-6">Interaction Timeline</h2>
            <p class="text-gray-400 text-sm mb-6">Shows when Claude queried lessons and what was returned. Click on retrievals to see relevance scores.</p>

            <div id="timeline" class="space-y-4">
                <!-- Timeline items will be populated here -->
                <div class="text-gray-500 text-center py-8">Loading session data...</div>
            </div>
        </div>
    </main>

    <script>
        /**
         * Session Detail Page
         * Shows the interaction history between Claude and the lesson memory system.
         */

        const API_BASE = window.location.origin;
        let sessionId = null;
        let events = [];

        /**
         * Get session ID from URL parameter or use most recent
         */
        function getSessionId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        /**
         * Fetch session data from API
         */
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                console.error(`API error (${endpoint}):`, err);
                return null;
            }
        }

        /**
         * Load session data and populate the page
         */
        async function loadSessionData() {
            // Get session ID from URL or fetch most recent
            sessionId = getSessionId();

            if (!sessionId) {
                const sessions = await fetchAPI('/api/sessions');
                if (sessions && sessions.length > 0) {
                    sessionId = sessions[0].id;
                    // Update URL without reload
                    history.replaceState(null, '', `?id=${sessionId}`);
                }
            }

            if (!sessionId) {
                document.getElementById('timeline').innerHTML =
                    '<div class="text-gray-500 text-center py-8">No sessions found.</div>';
                return;
            }

            document.getElementById('session-id').textContent = `Session: ${sessionId}`;

            // Fetch session events
            events = await fetchAPI(`/api/sessions/${sessionId}/events`);

            if (!events || events.length === 0) {
                document.getElementById('timeline').innerHTML =
                    '<div class="text-gray-500 text-center py-8">No events in this session.</div>';
                return;
            }

            // Update stats
            updateStats();

            // Render timeline
            renderTimeline();
        }

        /**
         * Update session statistics
         */
        function updateStats() {
            const queries = events.filter(e => e.event_type === 'query').length;
            const retrievals = events.filter(e => e.event_type === 'retrieve').length;
            const added = events.filter(e => e.event_type === 'add').length;

            document.getElementById('stat-queries').textContent = queries;
            document.getElementById('stat-retrievals').textContent = retrievals;
            document.getElementById('stat-lessons-added').textContent = added;

            // Calculate duration
            if (events.length > 0) {
                const start = new Date(events[0].timestamp);
                const end = new Date(events[events.length - 1].timestamp);
                const durationMs = end - start;
                const durationMin = Math.round(durationMs / 60000);
                document.getElementById('stat-duration').textContent =
                    durationMin < 60 ? `${durationMin}m` : `${Math.round(durationMin/60)}h`;
            }
        }

        /**
         * Render the interaction timeline
         */
        function renderTimeline() {
            const timeline = document.getElementById('timeline');

            // Group events by type for better visualization
            const html = events.map((event, index) => {
                const time = new Date(event.timestamp).toLocaleTimeString();
                const type = event.event_type;
                const payload = event.payload || {};

                // Different rendering based on event type
                switch (type) {
                    case 'session_start':
                        return renderSessionStart(time);
                    case 'query':
                        return renderQuery(time, payload, index);
                    case 'retrieve':
                        return renderRetrieval(time, payload, index);
                    case 'add':
                        return renderAdd(time, payload);
                    case 'refine':
                        return renderRefine(time, payload);
                    case 'link':
                        return renderLink(time, payload);
                    default:
                        return renderGeneric(time, type, payload);
                }
            }).join('');

            timeline.innerHTML = html || '<div class="text-gray-500 text-center py-8">No events to display.</div>';
        }

        /**
         * Render session start event
         */
        function renderSessionStart(time) {
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-gray-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-white/5 rounded-lg p-4 border-l-4 border-gray-500">
                        <div class="text-sm font-medium text-gray-400">Session Started</div>
                    </div>
                </div>
            `;
        }

        /**
         * Render query event - when Claude searched for lessons
         */
        function renderQuery(time, payload, index) {
            const queryText = payload.query_text || 'Unknown query';
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-brand-cyan mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-brand-cyan/10 rounded-lg p-4 border-l-4 border-brand-cyan">
                        <div class="text-xs text-brand-cyan uppercase tracking-wide mb-1">Query</div>
                        <div class="text-sm font-medium text-white">"${queryText}"</div>
                        <div class="text-xs text-gray-400 mt-2">Claude searched for relevant lessons</div>
                    </div>
                </div>
            `;
        }

        /**
         * Render retrieval event - what lessons were returned
         */
        function renderRetrieval(time, payload, index) {
            const lessonIds = payload.lesson_ids || [];
            const scores = payload.scores || [];
            const latency = payload.latency_ms ? `${Math.round(payload.latency_ms)}ms` : '';
            const queryId = payload.query_id || '';

            const lessonsHtml = lessonIds.map((id, i) => {
                const score = scores[i] ? Math.round(scores[i] * 100) : 0;
                const barWidth = score;
                return `
                    <div class="flex items-center gap-3 py-2">
                        <div class="w-48 text-sm text-gray-300 truncate" title="${id}">${id}</div>
                        <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full" style="width: ${barWidth}%"></div>
                        </div>
                        <div class="w-12 text-xs text-gray-400 text-right">${score}%</div>
                    </div>
                `;
            }).join('');

            // Link to query tree visualization
            const treeLink = `/query-tree?session_id=${sessionId}&query_id=${queryId}`;

            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-green-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-green-500/10 rounded-lg p-4 border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs text-green-400 uppercase tracking-wide">Retrieved ${lessonIds.length} Lessons</div>
                            <div class="flex items-center gap-3">
                                ${latency ? `<span class="text-xs text-gray-500">${latency}</span>` : ''}
                                <a href="${treeLink}" class="text-xs text-brand-cyan hover:text-white transition-colors flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    View Decision Tree
                                </a>
                            </div>
                        </div>
                        <div class="space-y-1">
                            ${lessonsHtml || '<div class="text-sm text-gray-400">No lessons returned</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Render add event - when Claude added a new lesson
         */
        function renderAdd(time, payload) {
            const lessonId = payload.lesson_id || 'Unknown';
            const trigger = payload.trigger || '';
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-purple-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-purple-500/10 rounded-lg p-4 border-l-4 border-purple-500">
                        <div class="text-xs text-purple-400 uppercase tracking-wide mb-1">Lesson Added</div>
                        <div class="text-sm font-medium text-white">${lessonId}</div>
                        ${trigger ? `<div class="text-xs text-gray-400 mt-2">Triggers: ${trigger.substring(0, 100)}${trigger.length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Render refine event - when Claude improved a lesson
         */
        function renderRefine(time, payload) {
            const lessonId = payload.lesson_id || 'Unknown';
            const version = payload.new_version || '?';
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-orange-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-orange-500/10 rounded-lg p-4 border-l-4 border-orange-500">
                        <div class="text-xs text-orange-400 uppercase tracking-wide mb-1">Lesson Refined</div>
                        <div class="text-sm font-medium text-white">${lessonId}</div>
                        <div class="text-xs text-gray-400 mt-2">Now at version ${version}</div>
                    </div>
                </div>
            `;
        }

        /**
         * Render link event - when Claude connected two lessons
         */
        function renderLink(time, payload) {
            const lessonA = payload.lesson_a || 'Unknown';
            const lessonB = payload.lesson_b || 'Unknown';
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-pink-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-pink-500/10 rounded-lg p-4 border-l-4 border-pink-500">
                        <div class="text-xs text-pink-400 uppercase tracking-wide mb-1">Lessons Linked</div>
                        <div class="text-sm font-medium text-white">${lessonA} &harr; ${lessonB}</div>
                    </div>
                </div>
            `;
        }

        /**
         * Render generic event
         */
        function renderGeneric(time, type, payload) {
            return `
                <div class="flex items-start gap-4">
                    <div class="w-24 text-xs text-gray-500 pt-1 text-right">${time}</div>
                    <div class="w-3 h-3 rounded-full bg-gray-500 mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 bg-white/5 rounded-lg p-4 border-l-4 border-gray-500">
                        <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">${type}</div>
                        <div class="text-xs text-gray-500 font-mono">${JSON.stringify(payload).substring(0, 100)}</div>
                    </div>
                </div>
            `;
        }

        // Initialize on page load
        loadSessionData();
    </script>
</body>
</html>
